sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/format/DateFormat","sap/ui/model/odata/v2/ODataModel","sap/m/upload/UploadSetwithTable","sap/m/upload/UploadSetwithTableItem"],function(e,t,a,i,s,l,r,o){"use strict";return e.extend("hmel.claims.hmelclaim.controller.ess",{onInit:function(){t.orientation.attachHandler(this.onOrientationChange,this);this._oModel=this.getView().getModel("MainModel");this.getView().setModel(new a({isNextButtonVisible:true,isSubmitButtonVisible:false}),"footerModel");var e=this.byId("myIconTabBar");e.attachSelect(this.onTabSelect,this);this.updateButtonVisibility();var i=new a;this.getView().setModel(i,"claimModel");this.updateTotalRequestedAmount();var s=new l("/odata/v4/my/");this.getView().setModel(s);var r=this.byId("Hospitallocation");r.attachChange(this.onHospitalLocationChange,this);var r=this.byId("TF");r.attachChange(this.onTreatmentChange,this)},formatDate:function(e){if(!e){return""}var t=s.getDateTimeInstance({pattern:"yyyy-MM-dd"});return t.format(e)},onListItemPress:function(e){var t=e.getParameter("listItem");if(t){var a=t.data("to");if(a){this.getSplitAppObj().toDetail(this.createId(a))}else{console.error("Invalid destination for list item.")}}},getSplitAppObj:function(){var e=this.getView();if(e){var t=e.byId("SplitContDemo");return t}return null},onOrientationChange:function(){},handleNext:function(){var e=this.byId("myIconTabBar");var t=e.getItems();var a=e.getSelectedKey();var s=t.findIndex(function(e){return e.getKey()===a});this.saveDataToClaimModel();var l=this.validateRequiredFields(a);if(l.length===0){if(a==="Create"){var r=this.byId("Accept");var o=r.getSelected();if(o){if(s<t.length-1){e.setSelectedKey(t[s+1].getKey());this.updateButtonVisibility()}}else{i.error("Please acknowledge and accept the terms and conditions.")}}else{if(s<t.length-1){e.setSelectedKey(t[s+1].getKey());this.updateButtonVisibility()}}}else{var n="Please fill in all required fields: "+l.join(", ");i.error(n)}},validateRequiredFields:function(e){var t=[];if(e==="claimDetails"){var a=this.byId("CT");var i=this.byId("TT");var s=this.byId("startDatePicker1");var l=this.byId("endDatePicker1");var r=this.byId("TF");var o=this.byId("SD");if(!a.getValue()){t.push("Claim Type");a.setValueState("Error")}if(!i.getValue()){t.push("Treatment Type");i.setValueState("Error")}if(!s.getDateValue()){t.push("Claim Start Date");s.setValueState("Error")}if(!l.getDateValue()){t.push("Claim End Date");l.setValueState("Error")}if(!r.getValue()){t.push("Treatment For");r.setValueState("Error")}if(!o.getValue()){t.push("Select Dependents");o.setValueState("Error")}}return t},handleBack:function(){var e=this.byId("myIconTabBar");var t=e.getItems();var a=e.getSelectedKey();var i=t.findIndex(function(e){return e.getKey()===a});if(i>0){e.setSelectedKey(t[i-1].getKey());this.updateButtonVisibility()}},updateButtonVisibility:function(){var e=this.byId("myIconTabBar");var t=this.getView().byId("BackButton");var a=this.getView().byId("nextButton");var i=this.getView().byId("submitButton");var s=e.getSelectedKey();if(s==="review"){t.setVisible(true);a.setVisible(false);i.setVisible(true)}else{t.setVisible(true);a.setVisible(true);i.setVisible(false)}},onTabSelect:function(e){this.updateButtonVisibility();var t=e.getParameter("key");if(t==="claimDetails"){var a=this.validateRequiredFields(this.byId("CT"),this.byId("TT"),this.byId("startDatePicker1"),this.byId("endDatePicker1"),this.byId("TF"),this.byId("SD"));if(a.length>0){var s="Please fill in all required fields: "+a.join(", ");i.error(s);this.byId("myIconTabBar").setSelectedKey(this.sLastSelectedTab);return}}this.sLastSelectedTab=t;if(t==="review"){this.updateTotalRequestedAmount()}},saveDataToClaimModel:function(){var e=this.getView().getModel("claimModel");e.setProperty("/claimType",this.byId("CT").getSelectedKey());e.setProperty("/claimStartDate",this.byId("startDatePicker1").getValue());e.setProperty("/claimEndDate",this.byId("endDatePicker1").getValue());e.setProperty("/treatmentFor",this.byId("TF").getSelectedKey());e.setProperty("/treatmentForOther",this.byId("TreatmentForOther").getValue());e.setProperty("/selectedDependent",this.byId("SD").getSelectedKey())},addPress:function(){var e=this.byId("startDatePicker1").getDateValue();var t=this.byId("endDatePicker1").getDateValue();var a=this.byId("requestamount");var s=this.byId("consultancycategorys").getSelectedKey();var l=this.byId("DN").getValue();var r=this.byId("ID").getValue();var o=this.byId("HospitalStore").getSelectedKey();var n=this.byId("Hospitallocation").getSelectedKey();var d=this.byId("HL").getValue();var u=this.byId("billdate").getDateValue();var c=this.byId("billno").getValue();var h=this.byId("billamount").getValue();var y=this.byId("discount").getValue();var b=this.byId("requestamount").getValue();var g=this.byId("description").getValue();var m=[];if(!s)m.push("Consultancy Category");if(!l)m.push("Doctor's Name");if(!r)m.push("Patient ID");if(!o)m.push("Hospital/Medical Store");if(!n)m.push("Hospital Location");if(!u)m.push("Bill Date");if(!c)m.push("Bill No");if(!h)m.push("Bill Amount(Rs)");if(!y)m.push("Discount(Rs)");if(!b)m.push("Requested Amount");if(m.length>0){var I="Please fill in the following required fields:\n"+m.join("\n");i.error(I);return}var v={category:s,doctor:l,patientId:r,hospitalStore:o,hospitalLocation:n,hospitalLocationOther:d,billDate:u,billNo:c,billAmount:h,discount:y,requestedAmount:b,review:g};var p=this.getView().getModel("claimModel");if(!p){p=new sap.ui.model.json.JSONModel;this.getView().setModel(p,"claimModel")}var f=p.getProperty("/allDetails")||[];f.push(v);p.setProperty("/allDetails",f);this.clearForm();this.updateTotalRequestedAmount()},clearForm:function(){this.byId("consultancycategorys").setSelectedKey("");this.byId("DN").setValue("");this.byId("ID").setValue("");this.byId("HospitalStore").setSelectedItem(null);this.byId("Hospitallocation").setSelectedItem(null);this.byId("HL").setValue("");this.byId("billdate").setValue(null);this.byId("billno").setValue("");this.byId("billamount").setValue("");this.byId("discount").setValue("");this.byId("requestamount").setValue("");this.byId("description").setValue("")},deletePress:function(){var e=this.byId("detailsList");var t=e.getSelectedItems();if(t.length===0){i.error("Please select an item to delete.");return}var a="Are you sure you want to delete the selected item?";i.confirm(a,{title:"Confirmation",actions:[i.Action.OK,i.Action.CANCEL],emphasizedAction:i.Action.CANCEL,onClose:function(e){if(e===i.Action.OK){this.deleteSelectedItems(t)}}.bind(this)})},deleteSelectedItems:function(e){var t=this.getView().getModel("claimModel");var a=t.getProperty("/allDetails");e.forEach(function(e){var t=e.getBindingContext("claimModel");var i=t.getPath().split("/").pop();a.splice(i,1)});t.setProperty("/allDetails",a);this.byId("detailsList").removeSelections();i.success("Selected items deleted successfully.");this.updateTotalRequestedAmount()},clonePress:function(){var e=this.byId("detailsList");var t=e.getSelectedItems();if(t.length!==1){i.error("Please select exactly one item to clone.");return}var a=t[0].getBindingContext("claimModel");var s=a.getProperty();var l=Object.assign({},s);this.setFormValues(l);i.success("Item cloned successfully.");this.byId("detailsList").removeSelections()},setFormValues:function(e){this.byId("consultancycategorys").setSelectedKey(e.category);this.byId("DN").setValue(e.doctor);this.byId("ID").setValue(e.patientId);this.byId("HospitalStore").setSelectedKey(e.hospitalStore);this.byId("Hospitallocation").setSelectedKey(e.hospitalLocation);this.byId("HL").setValue(e.hospitalLocationOther);this.byId("billdate").setValue(new Date(e.billDate));this.byId("billno").setValue(e.billNo);this.byId("billamount").setValue(e.billAmount);this.byId("discount").setValue(e.discount);this.byId("requestamount").setValue(e.requestedAmount);this.byId("description").setValue(e.review)},EditPress:function(){var e=this.byId("detailsList");var t=e.getSelectedItems();if(t.length!==1){i.error("Please select exactly one item to edit.");return}var a=t[0].getBindingContext("claimModel");var s=a.getProperty();this.setFormValues(s);this.toggleButtonsVisibility(false,true,true,false,false);this.updateTotalRequestedAmount()},UpdatePress:function(){var e=this.byId("detailsList");var t=e.getSelectedItems();if(t.length!==1){i.error("Please select exactly one item to update.");return}var a=t[0].getBindingContext("claimModel");if(!a){i.error("No data to update.");return}var s=a.getProperty();var l={category:this.byId("consultancycategorys").getSelectedKey(),doctor:this.byId("DN").getValue(),patientId:this.byId("ID").getValue(),hospitalStore:this.byId("HospitalStore").getSelectedKey(),hospitalLocation:this.byId("Hospitallocation").getSelectedKey(),hospitalLocationOther:this.byId("HL").getValue(),billDate:this.byId("billdate").getDateValue(),billNo:this.byId("billno").getValue(),billAmount:this.byId("billamount").getValue(),discount:this.byId("discount").getValue(),requestedAmount:this.byId("requestamount").getValue(),review:this.byId("description").getValue()};Object.assign(s,l);var r=this.getView().getModel("claimModel");var o=r.getProperty("/allDetails");var n=a.getPath().split("/").pop();o[n]=s;r.setProperty("/allDetails",o);this.enableFormFields(true);this.toggleButtonsVisibility(true,false,false,true,true);this.byId("detailsList").getBinding("items").refresh();i.success("Data updated successfully.");this.clearForm();this.byId("detailsList").removeSelections();this.updateTotalRequestedAmount()},CancelPress:function(){this.setFormValues(false);this.byId("detailsList").removeSelections();this.toggleButtonsVisibility(true,false,false,true,true);i.success("Editing canceled.")},enableFormFields:function(e){var t=["consultancycategorys","DN","ID","HospitalStore","Hospitallocation","HL","billdate","billno","billamount","discount","requestamount","description"];t.forEach(function(t){this.byId(t).setEnabled(e)}.bind(this))},toggleButtonsVisibility:function(e,t,a,i,s){this.byId("button").setVisible(e);this.byId("button2").setVisible(!t);this.byId("button3").setVisible(i);this.byId("buttonUpdate").setVisible(t);this.byId("buttonCancel").setVisible(a);this.byId("button4").setVisible(s)},handleDiscountChange:function(e){var t=e.getSource();var a=this.byId("billamount");var i=this.byId("requestamount");var s=this.byId("startDatePicker1").getDateValue();var l=this.byId("endDatePicker1").getDateValue();var r=t.getValue();var o=a.getValue();if(r&&o){var n=parseFloat(r);var d=parseFloat(o);var u=d-n;i.setValue(u.toFixed(2))}else{i.setValue("")}},onBillDateChange:function(){var e=this.byId("billdate");var t=this.byId("startDatePicker1");var a=this.byId("endDatePicker1");var s=e.getDateValue();var l=t.getDateValue();var r=a.getDateValue();if(l&&r&&s){if(s<l||s>r){i.error("Please select Bill Date between Claim Start Date and Claim End Date");e.setDateValue(null)}}},updateTotalRequestedAmount:function(){var e=0;var t=this.byId("detailsList").getItems();for(var a=0;a<t.length;a++){var i=t[a];var s=parseInt(i.getBindingContext("claimModel").getProperty("requestedAmount"));e+=s}this.byId("totalRequestedAmountLabel").setText("Total Requested Amount: "+e);this.byId("totalRequestedAmountValue").setText(e)},validateOnlyCharacters:function(e){var t=e.getSource();var a=t.getValue().trim();var i=/^[A-Za-z\s]*$/;var s=i.test(a);t.setValueState(s?"None":"Error");t.setValueStateText(s?"":"Only characters are allowed")},validateOnlyNumbers:function(e){var t=e.getSource();var a=t.getValue().trim();var i=/^[0-9]+$/;var s=i.test(a);t.setValueState(s?"None":"Error");t.setValueStateText(s?"":"Only numbers are allowed")},onHospitalLocationChange:function(e){var t=e.getSource().getSelectedKey();if(t==="OTHER"){sap.m.MessageBox.information("Please enter Hospital Location (If Other)")}},onTreatmentChange:function(e){var t=e.getSource().getSelectedKey();if(t==="OTHER"){sap.m.MessageBox.information(" Please enter Treatment For (If Other)")}},handleSubmit:function(){var e=this;var t=this.getView().getModel("claimModel").getData();var a=t.allDetails;var i="batch_01869434-0004";var s="changeset_01869434-0004-0001";var l=[];for(var r=0;r<a.length;r++){var o=a[r];var n={CLAIM_ID:parseInt((new Date).getTime()/1e3),PERSON_NUMBER:898989,CLAIM_TYPE:e.byId("claimt").getText(),CLAIM_START_DATE:new Date(e.byId("claimsd").getText()).toISOString(),CLAIM_END_DATE:new Date(e.byId("claimed").getText()).toISOString(),TREATMENT_FOR:e.byId("claimtf").getText(),TREATMENT_FOR_IF_OTHERS:e.byId("claimtfo").getText(),SELECT_DEPENDENTS:e.byId("claimsde").getText(),REQUESTED_AMOUNT:parseFloat(e.byId("totalRequestedAmountValue").getText()),CONSULTANCY_CATEGORY:o.category,MEDICAL_STORE:o.hospitalStore,BILL_DATE:new Date(o.billDate).toISOString(),BILL_NO:parseInt(o.billNo),BILL_AMOUNT:parseFloat(o.billAmount)};var d=JSON.stringify(n);var u=d.length;var c=["--"+s,"Content-Type: application/http","Content-Transfer-Encoding: binary","","POST CLAIM_DETAILS HTTP/1.1","Content-Type: application/json;odata.metadata=minimal","Content-Length: "+u,"",d].join("\r\n");l.push(c);var h=["--"+i,"Content-Type: multipart/mixed; boundary="+s,""].concat(l,"--"+s+"--","--"+i+"--").join("\r\n");fetch("./odata/v4/my/CLAIM_DETAILS",{method:"POST",headers:{"Content-Type":"multipart/mixed; boundary="+i},body:h}).then(e=>{if(!e.ok){throw new Error("Server responded with error status "+e.status)}return e.text()}).then(t=>{console.log("Response from server:",t);sap.m.MessageBox.success("Claim data saved successfully!",{onClose:function(){var t=sap.ui.core.UIComponent.getRouterFor(e);t.navTo("Login");window.location.reload()}})}).catch(e=>{console.error("Error while saving claim data:",e);sap.m.MessageBox.error("Error while saving claim data: "+e.message)})}},onBeforeInitiatingItemUpload:function(e){var t=this.byId("UploadSetTable");var a=e.getParameter("item");var i=t.getSelectedItems();var s=i.length===1?i[0]:null;if(s&&s.getFileName()==="-"){if(s){var l=s.getBindingContext();var r=l&&l.getObject?l.getObject():{};a.addHeaderField(new CoreItem({key:"existingDocumentID",text:r?r.id:""}))}}},onUploadCompleted:function(e){var t=this.getView().getModel();var a=e.getParameter("status");if(a===201){t.refresh(true);setTimeout(function(){MessageToast.show("Document Added")},1e3)}}})});